name: ECR Create

on:
  workflow_dispatch:
    inputs:
      event:
        type: choice
        description: 'Type of event'     
        required: true
        options:
        - push
        - create
        - delete
      image-tag:
        description: 'Image tag'
        required: false
        default: 'latest'
  push:
  create:
  delete:

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_PROFILE: ${{ vars.AWS_PROFILE }}
  AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
  AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
  ECR_ORG: KookaS
  ECR_REPO: infrastructure-modules
  ECR_BRANCH: master
  ECR_URI: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com
  DOCKER_FOLDER_PATH: ./Dockerfile
  IMAGE_TAG_THIS: ${{ github.sha }}
  AWS_CLI_ECR: ecr
  BRANCH_THIS: ${{ github.head_ref || github.ref_name }}

jobs:
  ecr:
    name: ECR
    runs-on: ubuntu-latest
    environment: KookaS
    env:
      LOG_FILE: log.out
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run script
        id: script
        run: |
          # setup AWS CLI
          aws --version
          aws configure set aws_access_key_id $AWS_ACCESS_KEY
          aws configure set aws_secret_access_key $AWS_SECRET_KEY
          aws configure set region $AWS_REGION

          # login to ECR
          if [[ $AWS_CLI_ECR == ecr ]]; then
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URI
          elif [[ $AWS_CLI_ECR == ecr-public ]]; then
            aws ecr-public get-login-password --region $AWS_REGION | docker login --username AWS ---password-stdin public.ecr.aws
          fi

          # setup variables
          ECR_REPOSITORY_NAME_SRC="$(echo ${ECR_ORG}-${ECR_REPO}-${ECR_BRANCH} | tr A-Z a-z)"
          ECR_IMAGE_TAG_SRC="${{ inputs.image-tag }}"
          ECR_IMAGE_TAG_SRC="${ECR_IMAGE_TAG_SRC:-latest}"
          ECR_REPOSITORY_NAME_THIS="$(echo ${{ github.repository_owner }}-$(basename ${{ github.repository }})-${BRANCH_THIS} | tr A-Z a-z)"
          IMAGE_KEEP_COUNT=$(if [[ $BRANCH_THIS == master ]]; then echo "5"; else echo "1"; fi)
          FORCE_DESTROY=$(if [[ $BRANCH_THIS == master ]]; then echo "false"; else echo "true"; fi)
          echo "event_name=${{ github.event_name }}"
          echo "inputs.event=${{ inputs.event }}"
          echo "ECR_REPOSITORY_NAME_SRC: $ECR_REPOSITORY_NAME_SRC"
          echo "ECR_IMAGE_TAG_SRC: $ECR_IMAGE_TAG_SRC"
          echo "ECR_REPOSITORY_NAME_THIS: $ECR_REPOSITORY_NAME_THIS"
          echo "IMAGE_KEEP_COUNT: $IMAGE_KEEP_COUNT"
          echo "FORCE_DESTROY: $FORCE_DESTROY"

          # describe ecr image
          echo -e '\033[44mECR IMAGE SRC\033[0m'::
          aws ${AWS_CLI_ECR} describe-images --repository-name ${ECR_REPOSITORY_NAME_SRC} --image-ids imageTag=latest --output json

          # create/push/delete ECR
          if [[ "${{ github.event_name }}" == "create" || ("${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.event }}" == "create") ]]; then
            echo -e '\033[43mCreating repository in ECR\033[0m'
            echo -e '\033[47mPulling worker image\033[0m'
            docker run \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -e AWS_REGION=$AWS_REGION \
              -e AWS_PROFILE=$AWS_PROFILE \
              -e AWS_ACCESS_KEY=$AWS_ACCESS_KEY \
              -e AWS_SECRET_KEY=$AWS_SECRET_KEY \
              -e AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID \
              $ECR_URI/$ECR_REPOSITORY_NAME_SRC:$ECR_IMAGE_TAG_SRC \
              /bin/sh -c " \
                make aws-configure; \
                make set-module-ecr \
                  REPOSITORY_NAME=$ECR_REPOSITORY_NAME_THIS \
                  FORCE_DESTROY=$FORCE_DESTROY \
                  IMAGE_KEEP_COUNT=$IMAGE_KEEP_COUNT \
              "
          elif [[ "${{ github.event_name }}" == "push" || ("${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.event }}" == "push") ]]; then
            echo -e '\033[43mPushing image to ECR\033[0m'
            echo -e '\033[47mPulling worker image\033[0m'
            REPOSITORY_NAME_EXISTING=$(aws $AWS_CLI_ECR describe-repositories --repository-names ${ECR_REPOSITORY_NAME_THIS} --query 'repositories[0].repositoryName')
              if [ -z ${REPOSITORY_NAME_EXISTING} ]; then
                echo -e '\033[43mCreating missing repository in ECR\033[0m': ${ECR_REPOSITORY_NAME_THIS}
                echo -e '\033[47mPulling worker image\033[0m'
                docker run \
                  -v /var/run/docker.sock:/var/run/docker.sock \
                  -e AWS_REGION=$AWS_REGION \
                  -e AWS_PROFILE=$AWS_PROFILE \
                  -e AWS_ACCESS_KEY=$AWS_ACCESS_KEY \
                  -e AWS_SECRET_KEY=$AWS_SECRET_KEY \
                  -e AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID \
                  $ECR_URI/$ECR_REPOSITORY_NAME_SRC:$ECR_IMAGE_TAG_SRC \
                  /bin/sh -c " \
                    make aws-configure; \
                    make set-module-ecr \
                      REPOSITORY_NAME=$ECR_REPOSITORY_NAME_THIS \
                      FORCE_DESTROY=$FORCE_DESTROY \
                      IMAGE_KEEP_COUNT=$IMAGE_KEEP_COUNT \
                  "
              else
                echo -e '\033[46mRepository already exists\033[0m'
              fi
              docker build --progress=plain --no-cache -t ${ECR_URI}/${IMAGE_TAG_THIS} -f ${DOCKER_FOLDER_PATH} .
              $(eval DOCKER_SRC=$(docker images -q ${ECR_URI}/${IMAGE_TAG_THIS}))
              echo -e '\033[44mIMAGE SIZE\033[0m' $(docker inspect -f "{{ .Size }}" ${DOCKER_SRC} | numfmt --to=si)
              docker tag ${DOCKER_SRC} ${ECR_URI}:${IMAGE_TAG_THIS}
              docker push ${ECR_URI}:${IMAGE_TAG_THIS}
              docker tag ${ECR_URI}:${IMAGE_TAG_THIS} ${ECR_URI}:latest
              docker push ${ECR_URI}:latest

              echo -e '\033[44mECR IMAGE THIS\033[0m'::
              aws ${AWS_CLI_ECR} describe-images --repository-name ${ECR_REPOSITORY_NAME_THIS} --image-ids imageTag=latest --output json


          elif [[ "${{ github.event_name }}" == "delete" || ("${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.event }}" == "delete") ]]; then
            echo -e '\033[43mDeleting repository in ECR\033[0m'
            aws ecr delete-repository --repository-name $ECR_REPOSITORY_NAME_THIS --force
          else
            echo -e '\033[41mError\033[0m'
            echo Error: event do not match, event_name ${{ github.event_name }}, inputs.event ${{ inputs.event }}
          fi